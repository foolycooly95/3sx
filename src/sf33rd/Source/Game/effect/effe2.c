/**
 * @file effe2.c
 * TODO: identify what this effect does
 */

#include "sf33rd/Source/Game/effect/effe2.h"
#include "bin2obj/char_table.h"
#include "common.h"
#include "sf33rd/Source/Game/effect/effect.h"
#include "sf33rd/Source/Game/engine/charset.h"
#include "sf33rd/Source/Game/engine/slowf.h"
#include "sf33rd/Source/Game/engine/workuser.h"
#include "sf33rd/Source/Game/rendering/aboutspr.h"

const s16 flames_stand[20][4][4] = { { { 1, -32, -16, 18 }, { 1, 16, 16, 57 }, { 3, 16, 24, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 32, -16, 57 }, { 2, 0, 0, 18 }, { 3, 32, 8, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 16, 8, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 32, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 8, 18 }, { 3, -16, 20, 18 } },
                                     { { 1, 0, -16, 57 }, { 3, -32, 24, 18 }, { 3, -16, 16, 18 }, { 3, 16, 8, 18 } },
                                     { { 1, 32, -16, 57 }, { 2, 0, 0, 18 }, { 3, 32, 8, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -20, 16, 18 }, { 3, 16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 24, 12, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 16, 8, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, -32, -16, 18 }, { 1, 16, 16, 57 }, { 3, 16, 24, 18 }, { 3, -16, 16, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } },
                                     { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 24, 12, 18 }, { 3, -16, 8, 18 } } };

const s16 flames_crunch[20][4][4] = { { { 1, 16, -16, 18 }, { 1, -32, 0, 57 }, { 3, -32, 8, 18 }, { 3, 32, -8, 18 } },
                                      { { 1, 16, 0, 57 }, { 0, 0, 0, 0 }, { 3, -24, 16, 18 }, { 3, 32, 0, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, -8, 18 }, { 3, 24, -8, 18 } },
                                      { { 1, 16, -8, 57 }, { 0, 0, 0, 0 }, { 3, -16, 16, 18 }, { 3, 16, 16, 18 } },
                                      { { 1, 8, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, 0, 18 } },
                                      { { 1, 16, 0, 57 }, { 0, 0, 0, 0 }, { 3, -24, 16, 18 }, { 3, 32, 0, 18 } },
                                      { { 1, 16, 32, 57 }, { 0, 0, 0, 0 }, { 3, -16, 0, 18 }, { 3, 32, 0, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -8, 0, 18 }, { 3, 24, 0, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, 16, 0, 18 }, { 3, 48, 0, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, -8, 18 }, { 3, 24, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 18 }, { 1, -32, 0, 57 }, { 3, -32, 8, 18 }, { 3, 32, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } },
                                      { { 1, 16, -16, 57 }, { 0, 0, 0, 0 }, { 3, -16, 8, 18 }, { 3, 16, -8, 18 } } };

const s16 flames_ariel[20][4][4] = { { { 1, 0, 0, 17 }, { 1, -20, -32, 18 }, { 1, 12, -32, 58 }, { 0, 0, 0, 0 } },
                                     { { 0, 16, -24, 18 }, { 2, -16, 0, 17 }, { 2, 16, -16, 58 }, { 0, 0, 0, 0 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -16, 0, 17 }, { 0, 0, 0, 0 }, { 3, -8, 8, 58 }, { 3, 16, 16, 18 } },
                                     { { 0, -16, 0, 17 }, { 0, 0, 0, 0 }, { 3, -32, 20, 58 }, { 3, 8, 8, 18 } },
                                     { { 3, -36, 32, 18 }, { 0, -16, -16, 17 }, { 3, 8, 16, 58 }, { 0, 0, 0, 0 } },
                                     { { 0, 16, -24, 18 }, { 2, -16, 0, 17 }, { 2, 16, -16, 58 }, { 0, 0, 0, 0 } },
                                     { { 0, 0, -32, 17 }, { 0, 0, 0, 0 }, { 3, -4, 4, 58 }, { 3, 24, 12, 18 } },
                                     { { 0, 8, -24, 17 }, { 0, 0, 0, 0 }, { 3, -8, 8, 58 }, { 3, 24, 16, 18 } },
                                     { { 0, 0, -16, 17 }, { 0, 0, 0, 0 }, { 3, -16, 8, 58 }, { 3, 16, 12, 18 } },
                                     { { 0, -16, -32, 17 }, { 0, 0, 0, 0 }, { 3, -8, 8, 58 }, { 3, 16, 16, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 3, -24, 8, 58 }, { 3, 8, 16, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 3, -24, 8, 58 }, { 3, 8, 16, 18 } },
                                     { { 1, 0, 0, 17 }, { 1, -20, -32, 18 }, { 1, 12, -32, 58 }, { 0, 0, 0, 0 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } },
                                     { { 0, -8, -24, 17 }, { 0, 0, 0, 0 }, { 2, -16, -16, 58 }, { 2, 16, -8, 18 } } };

const s16 freeze_stand[20][4][4] = { { { 1, -32, -16, 14 }, { 1, 16, -16, 53 }, { 3, 16, 24, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 32, -16, 53 }, { 2, 0, 0, 14 }, { 3, 32, 8, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 16, 8, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 32, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 8, 15 }, { 3, -16, 20, 16 } },
                                     { { 1, 0, -16, 53 }, { 3, -32, 24, 14 }, { 3, -16, 16, 15 }, { 3, 16, 8, 16 } },
                                     { { 1, 32, -16, 53 }, { 2, 0, 0, 14 }, { 3, 32, 8, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -20, 16, 15 }, { 3, 16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 24, 12, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 16, 8, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, -32, -16, 14 }, { 1, 16, -16, 53 }, { 3, 16, 24, 15 }, { 3, -16, 16, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } },
                                     { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 24, 12, 15 }, { 3, -16, 8, 16 } } };

const s16 freeze_crunch[20][4][4] = { { { 1, 16, -16, 14 }, { 1, -32, 0, 53 }, { 3, -32, 8, 15 }, { 3, 32, -8, 16 } },
                                      { { 1, 16, 0, 53 }, { 0, 0, 0, 0 }, { 3, -24, 16, 15 }, { 3, 32, 0, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, -8, 15 }, { 3, 24, -8, 16 } },
                                      { { 1, 16, -8, 53 }, { 0, 0, 0, 0 }, { 3, -16, 16, 15 }, { 3, 16, 16, 16 } },
                                      { { 1, 8, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, 0, 16 } },
                                      { { 1, 16, 0, 53 }, { 0, 0, 0, 0 }, { 3, -24, 16, 15 }, { 3, 32, 0, 16 } },
                                      { { 1, 16, 32, 53 }, { 0, 0, 0, 0 }, { 3, -16, 0, 15 }, { 3, 32, 0, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -8, 0, 15 }, { 3, 24, 0, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, 16, 0, 15 }, { 3, 48, 0, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, -8, 15 }, { 3, 24, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 14 }, { 1, -32, 0, 53 }, { 3, -32, 8, 15 }, { 3, 32, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } },
                                      { { 1, 16, -16, 53 }, { 0, 0, 0, 0 }, { 3, -16, 8, 15 }, { 3, 16, -8, 16 } } };

const s16 freeze_set_pos_B[20][4][4] = { { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } },
                                         { { 1, 5, 1, 53 }, { 2, 1, 1, 14 }, { 2, 2, 1, 15 }, { 3, 5, 1, 16 } } };

const s16 thunder_set_pos_SKB[20][4] = { { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 },
                                         { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 },
                                         { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 },
                                         { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 },
                                         { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 }, { 2, 5, 1, 23 } };

void effE2_sort_push(WORK* ewk, WORK* mwk);
void effe2_erase_or_die(WORK* wk);

void effect_E2_move(WORK_Other* ewk) {
    PLW* mwk = (PLW*)ewk->my_master;

    ewk->wu.hit_stop = mwk->wu.hit_stop;

    switch (ewk->wu.routine_no[0]) {
    case 0:
        ewk->wu.routine_no[0]++;

        if (ewk->wu.weight_level) {
            ewk->wu.disp_flag = 2;
        } else {
            ewk->wu.disp_flag = 1;
        }

        ewk->wu.cg_wca_ix = 0;
        set_char_move_init(&ewk->wu, 0, ewk->wu.char_index);
        effE2_sort_push(&ewk->wu, &mwk->wu);
        break;

    case 1:
        if (ewk->wu.dead_f == 1 || Suicide[0] != 0) {
            ewk->wu.disp_flag = 0;
            ewk->wu.routine_no[0] = 2;
            break;
        }

        switch (ewk->wu.routine_no[1]) {
        case 0:
            if (EXE_flag == 0 && Game_pause == 0) {
                char_move(&ewk->wu);

                if (ewk->wu.cg_type) {
                    if (ewk->wu.cg_type == 0xFF) {
                        ewk->wu.disp_flag = 0;
                        ewk->wu.routine_no[0] = 2;
                        break;
                    }

                    if (ewk->wu.cg_type == 1) {
                        ewk->wu.routine_no[1] = 1;
                        sort_push_request8(&ewk->wu);
                        break;
                    }
                }
            }

            if (ewk->wu.dir_old != mwk->wu.dm_count_up) {
                if (ewk->wu.dm_attribute == mwk->wu.dm_attribute) {
                    ewk->wu.disp_flag = 0;
                    ewk->wu.routine_no[0] = 2;
                    break;
                }

                effe2_erase_or_die(&ewk->wu);
                break;
            }

            if (ewk->wu.type != 0 && ewk->wu.type != 32) {
                if (mwk->wu.xyz[1].disp.pos <= 0) {
                    effe2_erase_or_die(&ewk->wu);
                    break;
                }
            } else if (mwk->wu.cg_type != 0) {
                effe2_erase_or_die(&ewk->wu);
                break;
            }

            effE2_sort_push(&ewk->wu, &mwk->wu);
            break;

        default:
            if (EXE_flag == 0 && Game_pause == 0) {
                char_move(&ewk->wu);

                if (ewk->wu.cg_type && ewk->wu.cg_type == 0xFF) {
                    ewk->wu.disp_flag = 0;
                    ewk->wu.routine_no[0] = 2;
                    break;
                }
            }

            sort_push_request8(&ewk->wu);
            break;
        }

        break;

    case 2:
        ewk->wu.routine_no[0] = 3;
        break;

    default:
        all_cgps_put_back(&ewk->wu);
        push_effect_work(&ewk->wu);
        break;
    }
}

void effE2_sort_push(WORK* ewk, WORK* mwk) {
    if (ewk->rl_flag) {
        ewk->position_x = mwk->xyz[0].disp.pos + ewk->old_pos[0];
    } else {
        ewk->position_x = mwk->xyz[0].disp.pos - ewk->old_pos[0];
    }

    ewk->position_y = mwk->xyz[1].disp.pos + ewk->old_pos[1];
    ewk->position_z = mwk->position_z + ewk->old_pos[2];
    ewk->xyz[0].disp.pos = ewk->position_x;
    ewk->xyz[1].disp.pos = ewk->position_y;
    ewk->xyz[2].disp.pos = ewk->position_z;
    sort_push_request8(ewk);
}

void effe2_erase_or_die(WORK* wk) {
    if (wk->cg_wca_ix != 0) {
        wk->routine_no[1] = 1;
        char_move_wca(wk);
        sort_push_request8(wk);
    } else {
        wk->disp_flag = 0;
        wk->routine_no[0] = 2;
    }
}

s32 effect_E2_init(PLW* wk, const s16* data, s16 color_code, u8 ff) {
    WORK_Other* ewk;
    s16* bxt;
    s16 ix;

    if (data[3] == 0) {
        return -1;
    }

    bxt = wk->wu.h_bod->body_dm[data[0]];

    if (bxt[1] == 0) {
        return -1;
    }

    if ((ix = pull_effect_work(3)) == -1) {
        return -1;
    }

    ewk = (WORK_Other*)frw[ix];
    ewk->wu.be_flag = 1;
    ewk->wu.id = 142;
    ewk->wu.work_id = 16;

    if (wk->wu.rl_flag) {
        ewk->wu.rl_flag = 0;
    } else {
        ewk->wu.rl_flag = 1;
    }

    ewk->wu.dir_old = wk->wu.dm_count_up;
    ewk->wu.dm_attribute = wk->wu.dm_attribute;
    ewk->wu.type = wk->wu.pat_status;
    ewk->wu.blink_timing = wk->wu.blink_timing;
    ewk->wu.old_pos[2] = -1;
    ewk->wu.char_index = data[3];
    ewk->my_master = wk;
    ewk->wu.target_adrs = wk;
    ewk->master_id = wk->wu.id;
    ewk->master_work_id = wk->wu.work_id;
    ewk->master_player = wk->player_number;
    ewk->wu.cgromtype = 1;
    ewk->wu.my_col_mode = 0x4200;
    ewk->wu.my_col_code = color_code | 0x2000;
    ewk->wu.my_family = 2;
    ewk->wu.my_mr_flag = 0;
    *ewk->wu.char_table = _plef_char_table;
    ewk->wu.old_pos[0] = bxt[0] + (bxt[1] >> 1) + data[1];
    ewk->wu.old_pos[1] = bxt[2] + (bxt[3] >> 1) + data[2];
    ewk->wu.charset_id = 0;

    if (ff) {
        if (ewk->wu.char_index & 1) {
            ewk->wu.charset_id = 4;
        } else {
            ewk->wu.charset_id = 5;
        }
    }

    ewk->wu.weight_level = ff;
    return 0;
}

s32 setup_accessories(PLW* wk, u8 data) {
    s16 i;

    if (wk->wu.work_id != 1) {
        return -1;
    }

    switch (data) {
    case 0:
        if (wk->wu.dm_attribute == 1) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, flames_stand[wk->player_number][i], 32, 1);
            }
        }

        if (wk->wu.dm_attribute == 2) {
            effect_E2_init(wk, thunder_set_pos_SKB[wk->player_number], 32, 0);
        }

        if (wk->wu.dm_attribute == 3) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, freeze_stand[wk->player_number][i], 32, 0);
            }
        }

        break;

    case 32:
        if (wk->wu.dm_attribute == 1) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, flames_crunch[wk->player_number][i], 32, 1);
            }
        }

        if (wk->wu.dm_attribute == 2) {
            effect_E2_init(wk, thunder_set_pos_SKB[wk->player_number], 32, 0);
        }

        if (wk->wu.dm_attribute == 3) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, freeze_crunch[wk->player_number][i], 32, 0);
            }
        }

        break;

    default:
        if (wk->wu.dm_attribute == 1) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, flames_ariel[wk->player_number][i], 32, 1);
            }
        }

        if (wk->wu.dm_attribute == 2) {
            effect_E2_init(wk, thunder_set_pos_SKB[wk->player_number], 32, 0);
        }

        if (wk->wu.dm_attribute == 3) {
            for (i = 0; i < 4; i++) {
                effect_E2_init(wk, freeze_set_pos_B[wk->player_number][i], 32, 0);
            }
        }

        break;
    }

    return 0;
}
